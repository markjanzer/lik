<div class="practice-session__show">
  <%= partial "partials/chartist-js" %>

  <section class="container section section--top">
    <div class="practice-session__header">
      <h1 class="practice-session__header"><%= find(:keyboards, practice_session.keyboard[0]).acronym %> #<%= practice_session.number %></h1>
      <div class="practice-session__header-date"> â€” <%= Date.parse(practice_session.date).strftime("%Y/%m/%d") %></div>
    </div>

    <div class="practice-session__notes">
      <%= practice_session.notes %>
    </div>

    <div class="section row">
      <ul class="col-8">
        <% domains = find_all(:exercises, practice_session.exercises).map { |exercise| exercise.domain[0] }.uniq %>
        <% exercises_practice_sessions = find_all(:exercises_practice_sessions, practice_session.exercises_practice_sessions) %>
        <% keyboard = find(:keyboards, practice_session.keyboard) %>

        <% domains.each do |domain| %>
          <% domain_exercises_practice_sessions = exercises_practice_sessions.select { |eps| find(:exercise, eps.exercise).domain == domain.id } %>
          <% domain_time = domain_exercises_practice_sessions.reduce(0) { |sum, eps| sum + (eps.time_practiced || 0) } %>
          <% domain_exercises = find_all(:exercises, practice_session.exercises).select { |exercise| exercise.domain[0] == domain.id } %>
          <li class="domain">
            <div class="domain-header">
              <div class="domain-header__title">
                <%= domain.name %>
              </div>
              <div class="domain-header__time">
                <%= domain_time %>
              </div>
            </div>
            <ul class="exercise-sets">
              <% domain_exercises_practice_sessions.each do |eps| %>
                <div class="exercise-set">
                  <div class="exercise-set__header">
                    <div class="exercise-set__title">
                      <%= find(:exercises, esp.exercise).name %>
                    </div>
                    <div class="exercise-set__time">
                      <%= eps.time_practiced %>
                    </div>
                  </div>
                  <% completed_increments = find_all(:exercise_increments, eps.tk_completed || eps.lik_completed) %>
                  <% if completed_increments.length > 0 %>
                    <div class="exercise-set__data">
                      <ul class="exercise-set__increments">
                        <% completed_increments.each do |ci| %>
                          <li>
                            <%= ci.name %>
                          </li>
                        <% end %>
                      </ul>
                      <div class="exercise-set__increments-summary">
                        <%= completed_increments.length %> increments completed
                      </div>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </ul>
          </li>
        <% end %>
      </ul>
    </div>
  </section>


  <div class="container section section--top">
    <div><h1><%= practice_session.name %></h1></div>
    <div class="row">
      <div class="col-12 col-lg-6">
        <div>Practice Session #<%= practice_session.number %></div>
        <div>Date: <%= Date.parse(practice_session.date).strftime("%B %e, %Y") %></div>
        <% if practice_session.notes %>
          <div>Notes: <%= practice_session.notes %></div>
        <% end %>
        <% if practice_session.recording %>
          <div><a href="<%= practice_session.recording %>" class="recording-link">Recording</a></div>
        <% else %>
          <div>Recording not uploaded yet</div>
        <% end %>
        <% if practice_session.reflection_url %>
          <div><a href="<%= practice_session.reflection_url %>" class="reflection-link">Reflection</a></div>
        <% end %>
      </div>
    </div>

    <div class="row section">
      <div class="col-12 col-lg-6">
        <h3>Practiced</h3>
        <ul>
          <% find_all(:exercises, practice_session.exercises).each do |exercise| %>
            <li><%= exercise.name %></li>
          <% end %>
        </ul>
      </div>

      <div class="col-12 col-lg-6">
        <h3>Completed</h3>
        <ul>
          <% if completed_increments(practice_session).empty? %>
            <li>None</li>
          <% else %>
            <% completed_increments(practice_session).each do |completed_increment| %>
              <li><%= completed_increment.name %></li>
            <% end %>
          <% end %>
        </ul>
      </div>
    </div>
    
    <div class="section">
      <div class="row justify-content-center">
        <div class="col-12 col-lg-8"><h3>Progress</h3></div>
      </div>
      <div class="row justify-content-center">
        <div class="ct-chart chart--medium col-12 col-lg-8"></div>
      </div>
    </div>
  </div>
</div>


<script src="/javascripts/blocks/chartist-options.js"></script>
<script>
  var data = <%= progress_until_practice_session(practice_session).to_json %>
  new Chartist.Line('.ct-chart', data, basicOptions);
</script>